"use strict";angular.module("mentio",[]).directive("mentio",["mentioUtil","$document","$compile","$log","$timeout",function(e,t,n,r,i){return{restrict:"A",scope:{macros:"=mentioMacros",search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"@mentioTriggerChar",typedTerm:"=mentioTypedTerm",altId:"=mentioId",iframeElement:"=mentioIframeElement",requireLeadingSpace:"=mentioRequireLeadingSpace",selectNotFound:"=mentioSelectNotFound",trimTerm:"=mentioTrimTerm",ngModel:"="},controller:["$scope","$element","$attrs",function(r,o,a){function l(e){e.stopImmediatePropagation()}function c(){for(var e in r.triggerCharMap)if(r.triggerCharMap.hasOwnProperty(e)&&r.triggerCharMap[e].visible)return r.triggerCharMap[e];return null}this.keyHandler=function(e){var t=c();if(t){if(9===e.which||13===e.which)return l(e),t.selectActive(),!1;if(27===e.which)return l(e),t.$apply(function(){t.hideMenu()}),!1;if(40===e.which)return l(e),t.$apply(function(){t.activateNextItem()}),t.adjustScroll(1),!1;if(38===e.which)return l(e),t.$apply(function(){t.activatePreviousItem()}),t.adjustScroll(-1),!1;if(37===e.which||39===e.which)return l(e),!1}},this.addMenu=function(e,t){e.targetScope=r;var i='<mentio-menu mentio-items="'+t.items+'"';t.search&&(i=i+' mentio-search="'+t.search+'"'),t.select&&(i=i+' mentio-select="'+t.select+'"'),t.templateUrl&&(i=i+' mentio-template-url="'+t.templateUrl+'"'),i=i+' mentio-trigger-char="'+t.triggerChar+'" mentio-parent-scope="targetScope"/>';var a=n(i)(e);o.parent().append(a),e.$on("$destroy",function(){a.remove()})},r.query=function(e,t){var n=r.triggerCharMap[e];(void 0===r.trimTerm||r.trimTerm)&&(t=t.trim()),n.query(t)},r.setTriggerText=function(e){r.syncTriggerText&&(r.typedTerm=void 0===r.trimTerm||r.trimTerm?e.trim():e)},r.context=function(){return r.iframeElement?{iframe:r.iframeElement}:void 0},r.replaceText=function(t,n){if(r.hideAll(),e.replaceTriggerText(r.context(),r.targetElement,r.targetElementPath,r.targetElementSelectedOffset,r.triggerCharSet,t,r.requireLeadingSpace,n),!n&&(r.setTriggerText(""),angular.element(r.targetElement).triggerHandler("change"),r.isContentEditable())){r.contentEditableMenuPasted=!0;var o=i(function(){r.contentEditableMenuPasted=!1},200);r.$on("$destroy",function(){i.cancel(o)})}},r.hideAll=function(){for(var e in r.triggerCharMap)r.triggerCharMap.hasOwnProperty(e)&&r.triggerCharMap[e].hideMenu()},r.selectActive=function(){for(var e in r.triggerCharMap)r.triggerCharMap.hasOwnProperty(e)&&r.triggerCharMap[e].visible&&r.triggerCharMap[e].selectActive()},r.isActive=function(){for(var e in r.triggerCharMap)if(r.triggerCharMap.hasOwnProperty(e)&&r.triggerCharMap[e].visible)return!0;return!1},r.isContentEditable=function(){return"INPUT"!==r.targetElement.nodeName&&"TEXTAREA"!==r.targetElement.nodeName},r.replaceMacro=function(t,n){n?e.replaceMacroText(r.context(),r.targetElement,r.targetElementPath,r.targetElementSelectedOffset,r.macros,r.macros[t]):(r.replacingMacro=!0,r.timer=i(function(){e.replaceMacroText(r.context(),r.targetElement,r.targetElementPath,r.targetElementSelectedOffset,r.macros,r.macros[t]),angular.element(r.targetElement).triggerHandler("change"),r.replacingMacro=!1},300),r.$on("$destroy",function(){i.cancel(r.timer)}))},r.addMenu=function(e){e.targetScope&&r.triggerCharMap.hasOwnProperty(e.triggerChar)||(r.triggerCharMap[e.triggerChar]=e,void 0===r.triggerCharSet&&(r.triggerCharSet=[]),r.triggerCharSet.push(e.triggerChar),e.setParent(r))},r.$on("menuCreated",function(e,t){(void 0!==a.id||void 0!==a.mentioId)&&(a.id===t.targetElement||void 0!==a.mentioId&&r.altId===t.targetElement)&&r.addMenu(t.scope)}),t.on("click",function(){r.isActive()&&r.$apply(function(){r.hideAll()})})}],link:function(t,n,o,a){t.triggerCharMap={},t.targetElement=n,o.$set("autocomplete","off"),o.mentioItems&&a.addMenu(t,{items:"items",search:o.mentioSearch?"search(scope,term)":void 0,select:o.mentioSelect?"select(scope,item)":void 0,triggerChar:o.mentioTriggerChar?o.mentioTriggerChar:"@",templateUrl:o.mentioTemplateUrl}),o.mentioTypedTerm&&(t.syncTriggerText=!0),n.on("keydown keypress paste",a.keyHandler),t.$watch("iframeElement",function(e){if(e){var n=e.contentWindow.document;n.addEventListener("click",function(){t.isActive()&&t.$apply(function(){t.hideAll()})}),n.addEventListener("keydown",a.keyHandler,!0),t.$on("$destroy",function(){n.removeEventListener("keydown",a.keyHandler)})}}),t.$watch("ngModel",function(n){if(n&&""!==n||t.isActive()){if(void 0===t.triggerCharSet)return r.error("Error, no mentio-items attribute was provided, and no separate mentio-menus were specified.  Nothing to do."),void 0;if(t.contentEditableMenuPasted)return t.contentEditableMenuPasted=!1,void 0;t.replacingMacro&&(i.cancel(t.timer),t.replacingMacro=!1);var o=t.isActive(),a=t.isContentEditable(),l=e.getTriggerInfo(t.context(),t.triggerCharSet,t.requireLeadingSpace,o);if(void 0!==l&&(!o||o&&(a&&l.mentionTriggerChar===t.currentMentionTriggerChar||!a&&l.mentionPosition===t.currentMentionPosition)))l.mentionSelectedElement&&(t.targetElement=l.mentionSelectedElement,t.targetElementPath=l.mentionSelectedPath,t.targetElementSelectedOffset=l.mentionSelectedOffset),t.setTriggerText(l.mentionText),t.currentMentionPosition=l.mentionPosition,t.currentMentionTriggerChar=l.mentionTriggerChar,t.query(l.mentionTriggerChar,l.mentionText);else{var c=t.typedTerm;t.setTriggerText(""),t.hideAll();var s=e.getMacroMatch(t.context(),t.macros);if(void 0!==s)t.targetElement=s.macroSelectedElement,t.targetElementPath=s.macroSelectedPath,t.targetElementSelectedOffset=s.macroSelectedOffset,t.replaceMacro(s.macroText,s.macroHasTrailingSpace);else if(t.selectNotFound&&c&&""!==c){var m=t.triggerCharMap[t.currentMentionTriggerChar];if(m){var g=m.select({item:{label:c},scope:m});"function"==typeof g.then?g.then(t.replaceText):t.replaceText(g,!0)}}}}})}}}]).directive("mentioMenu",["mentioUtil","$rootScope","$log","$window","$document",function(e,t,n,r,i){return{restrict:"E",scope:{search:"&mentioSearch",select:"&mentioSelect",items:"=mentioItems",triggerChar:"@mentioTriggerChar",forElem:"=mentioFor",targetScope:"=mentioParentScope"},templateUrl:function(e,t){return void 0!==t.mentioTemplateUrl?t.mentioTemplateUrl:"mentio-menu.tpl.html"},controller:["$scope",function(e){e.visible=!1,this.activate=e.activate=function(t){e.activeItem=t},this.isActive=e.isActive=function(t){return e.activeItem===t},this.selectItem=e.selectItem=function(t){var n=e.select({item:t,scope:e});"function"==typeof n.then?n.then(e.parentMentio.replaceText):e.parentMentio.replaceText(n)},e.activateNextItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[(t+1)%e.items.length])},e.activatePreviousItem=function(){var t=e.items.indexOf(e.activeItem);this.activate(e.items[0===t?e.items.length-1:t-1])},e.isFirstItemActive=function(){var t=e.items.indexOf(e.activeItem);return 0===t},e.isLastItemActive=function(){var t=e.items.indexOf(e.activeItem);return t===e.items.length-1},e.selectActive=function(){e.selectItem(e.activeItem)},e.isVisible=function(){return e.visible},e.query=function(t){e.visible||(e.requestVisiblePendingSearch=!0);var n=e.search({term:t,scope:e});n&&n.then?n.then(function(t){e.filteredItems=t}):e.filteredItems=n,e.typedTerm=t},e.setParent=function(t){e.parentMentio=t,e.targetElement=t.targetElement},e.filteredItems=[]}],link:function(o,a,l){if(a[0].parentNode.removeChild(a[0]),i[0].body.appendChild(a[0]),o.menuElement=a,o.targetScope)o.targetScope.addMenu(o);else{if(!o.forElem)return n.error("mentio-menu requires a target element in tbe mentio-for attribute"),void 0;if(!o.triggerChar)return n.error("mentio-menu requires a trigger char"),void 0;t.$broadcast("menuCreated",{targetElement:o.forElem,scope:o})}l.mentioSearch||(o.search=e.defaultSearch),l.mentioSelect||(o.select=e.defaultSelect),angular.element(r).bind("resize",function(){if(o.isVisible()){var t=[];t.push(o.triggerChar),e.popUnderMention(o.parentMentio.context(),t,a,o.requireLeadingSpace)}}),o.$watch("filteredItems",function(e){e&&e.length>0?(o.activate(e[0]),!o.visible&&o.requestVisiblePendingSearch&&(o.visible=!0,o.requestVisiblePendingSearch=!1)):o.hideMenu()}),o.$watch("isVisible()",function(t){if(t){var n=[];n.push(o.triggerChar),e.popUnderMention(o.parentMentio.context(),n,a,o.requireLeadingSpace)}}),o.parentMentio.$on("$destroy",function(){a.remove()}),o.hideMenu=function(){o.visible=!1,a.css("display","none")},o.adjustScroll=function(e){var t=a[0],n=t.querySelector("ul"),r=t.querySelector("[mentio-menu-item].active")||t.querySelector("[data-mentio-menu-item].active");return o.isFirstItemActive()?n.scrollTop=0:o.isLastItemActive()?n.scrollTop=n.scrollHeight:(1===e?n.scrollTop+=r.offsetHeight:n.scrollTop-=r.offsetHeight,void 0)}}}}]).directive("mentioMenuItem",function(){return{restrict:"A",scope:{item:"=mentioMenuItem"},require:"^mentioMenu",link:function(e,t,n,r){e.$watch(function(){return r.isActive(e.item)},function(e){e?t.addClass("active"):t.removeClass("active")}),t.bind("mouseenter",function(){e.$apply(function(){r.activate(e.item)})}),t.bind("click",function(){return r.selectItem(e.item),!1})}}}).filter("unsafe",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]).filter("mentioHighlight",function(){function e(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(t,n,r){if(n){var i=r?'<span class="'+r+'">$&</span>':"<strong>$&</strong>";return(""+t).replace(new RegExp(e(n),"gi"),i)}return t}}),angular.module("mentio").factory("mentioUtil",["$window","$location","$anchorScroll","$timeout",function(e,t,n,r){function i(e,t,n,i){var l,c=h(e,t,i,!1);void 0!==c?(l=a(e)?C(e,v(e).activeElement,c.mentionPosition):S(e,c.mentionPosition),n.css({top:l.top+"px",left:l.left+"px",position:"absolute",zIndex:1e4,display:"block"}),r(function(){o(e,n)},0)):n.css({display:"none"})}function o(t,n){for(var r,i=20,o=100,a=n[0];void 0===r||0===r.height;)if(r=a.getBoundingClientRect(),0===r.height&&(a=a.childNodes[0],void 0===a||!a.getBoundingClientRect))return;var l=r.top,c=l+r.height;if(0>l)e.scrollTo(0,e.pageYOffset+r.top-i);else if(c>e.innerHeight){var s=e.pageYOffset+r.top-i;s-e.pageYOffset>o&&(s=e.pageYOffset+o);var m=e.pageYOffset-(e.innerHeight-c);m>s&&(m=s),e.scrollTo(0,m)}}function a(e){var t=v(e).activeElement;if(null!==t){var n=t.nodeName,r=t.getAttribute("type");return"INPUT"===n&&"text"===r||"TEXTAREA"===n}return!1}function l(e,t,n,r){var i,o=t;if(n)for(var a=0;a<n.length;a++){if(o=o.childNodes[n[a]],void 0===o)return;for(;o.length<r;)r-=o.length,o=o.nextSibling;0!==o.childNodes.length||o.length||(o=o.previousSibling)}var l=p(e);i=v(e).createRange(),i.setStart(o,r),i.setEnd(o,r),i.collapse(!0);try{l.removeAllRanges()}catch(c){}l.addRange(i),t.focus()}function c(e,t,n,r){var i,o;o=p(e),i=v(e).createRange(),i.setStart(o.anchorNode,n),i.setEnd(o.anchorNode,r),i.deleteContents();var a=v(e).createElement("div");a.innerHTML=t;for(var l,c,s=v(e).createDocumentFragment();l=a.firstChild;)c=s.appendChild(l);i.insertNode(s),c&&(i=i.cloneRange(),i.setStartAfter(c),i.collapse(!0),o.removeAllRanges(),o.addRange(i))}function s(e,t,n,r){var i=t.nodeName;"INPUT"===i||"TEXTAREA"===i?t!==v(e).activeElement&&t.focus():l(e,t,n,r)}function m(e,t,n,r,i,o){s(e,t,n,r);var l=d(e,i);if(l.macroHasTrailingSpace&&(l.macroText=l.macroText+" ",o+=" "),void 0!==l){var m=v(e).activeElement;if(a(e)){var g=l.macroPosition,u=l.macroPosition+l.macroText.length;m.value=m.value.substring(0,g)+o+m.value.substring(u,m.value.length),m.selectionStart=g+o.length,m.selectionEnd=g+o.length}else c(e,o,l.macroPosition,l.macroPosition+l.macroText.length)}}function g(e,t,n,r,i,o,l,m){s(e,t,n,r);var g=h(e,i,l,!0,m);if(void 0!==g)if(a()){var u=v(e).activeElement;o+=" ";var d=g.mentionPosition,f=g.mentionPosition+g.mentionText.length+1;u.value=u.value.substring(0,d)+o+u.value.substring(f,u.value.length),u.selectionStart=d+o.length,u.selectionEnd=d+o.length}else o+=" ",c(e,o,g.mentionPosition,g.mentionPosition+g.mentionText.length+1)}function u(e,t){if(null===t.parentNode)return 0;for(var n=0;n<t.parentNode.childNodes.length;n++){var r=t.parentNode.childNodes[n];if(r===t)return n}}function d(e,t){var n,r,i=[];if(a(e))n=v(e).activeElement;else{var o=f(e);o&&(n=o.selected,i=o.path,r=o.offset)}var l=T(e);if(void 0!==l&&null!==l){var c,s=!1;if(l.length>0&&(" "===l.charAt(l.length-1)||" "===l.charAt(l.length-1))&&(s=!0,l=l.substring(0,l.length-1)),angular.forEach(t,function(e,t){var o=l.toUpperCase().lastIndexOf(t.toUpperCase());if(o>=0&&t.length+o===l.length){var a=o-1;(0===o||" "===l.charAt(a)||" "===l.charAt(a))&&(c={macroPosition:o,macroText:t,macroSelectedElement:n,macroSelectedPath:i,macroSelectedOffset:r,macroHasTrailingSpace:s})}}),c)return c}}function f(e){var t,n=p(e),r=n.anchorNode,i=[];if(null!=r){for(var o,a=r.contentEditable;null!==r&&"true"!==a;)o=u(e,r),i.push(o),r=r.parentNode,null!==r&&(a=r.contentEditable);return i.reverse(),t=n.getRangeAt(0).startOffset,{selected:r,path:i,offset:t}}}function h(e,t,n,r,i){var o,l,c;if(a(e))o=v(e).activeElement;else{var s=f(e);s&&(o=s.selected,l=s.path,c=s.offset)}var m=T(e);if(void 0!==m&&null!==m){var g,u=-1;if(t.forEach(function(e){var t=m.lastIndexOf(e);t>u&&(u=t,g=e)}),u>=0&&(0===u||!n||/[\xA0\s]/g.test(m.substring(u-1,u)))){var d=m.substring(u+1,m.length);g=m.substring(u,u+1);var h=d.substring(0,1),p=d.length>0&&(" "===h||" "===h);if(i&&(d=d.trim()),!p&&(r||!/[\xA0\s]/g.test(d)))return{mentionPosition:u,mentionText:d,mentionSelectedElement:o,mentionSelectedPath:l,mentionSelectedOffset:c,mentionTriggerChar:g}}}}function p(e){return e?e.iframe.contentWindow.getSelection():window.getSelection()}function v(e){return e?e.iframe.contentWindow.document:document}function T(e){var t;if(a(e)){var n=v(e).activeElement,r=n.selectionStart;t=n.value.substring(0,r)}else{var i=p(e).anchorNode;if(null!=i){var o=i.textContent,l=p(e).getRangeAt(0).startOffset;l>=0&&(t=o.substring(0,l))}}return t}function S(e,t){var n,r,i="﻿",o="sel_"+(new Date).getTime()+"_"+Math.random().toString().substr(2),a=p(e),l=a.getRangeAt(0);r=v(e).createRange(),r.setStart(a.anchorNode,t),r.setEnd(a.anchorNode,t),r.collapse(!1),n=v(e).createElement("span"),n.id=o,n.appendChild(v(e).createTextNode(i)),r.insertNode(n),a.removeAllRanges(),a.addRange(l);var c={left:0,top:n.offsetHeight};return E(e,n,c),n.parentNode.removeChild(n),c}function E(e,t,n){for(var r=t,i=e?e.iframe:null;r;)n.left+=r.offsetLeft+r.clientLeft,n.top+=r.offsetTop+r.clientTop,r=r.offsetParent,!r&&i&&(r=i,i=null);for(r=t,i=e?e.iframe:null;r!==v().body;)r.scrollTop&&r.scrollTop>0&&(n.top-=r.scrollTop),r.scrollLeft&&r.scrollLeft>0&&(n.left-=r.scrollLeft),r=r.parentNode,!r&&i&&(r=i,i=null)}function C(e,t,n){var r=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],i=null!==window.mozInnerScreenX,o=v(e).createElement("div");o.id="input-textarea-caret-position-mirror-div",v(e).body.appendChild(o);var a=o.style,l=window.getComputedStyle?getComputedStyle(t):t.currentStyle;a.whiteSpace="pre-wrap","INPUT"!==t.nodeName&&(a.wordWrap="break-word"),a.position="absolute",a.visibility="hidden",r.forEach(function(e){a[e]=l[e]}),i?(a.width=parseInt(l.width)-2+"px",t.scrollHeight>parseInt(l.height)&&(a.overflowY="scroll")):a.overflow="hidden",o.textContent=t.value.substring(0,n),"INPUT"===t.nodeName&&(o.textContent=o.textContent.replace(/\s/g," "));var c=v(e).createElement("span");c.textContent=t.value.substring(n)||".",o.appendChild(c);var s={top:c.offsetTop+parseInt(l.borderTopWidth)+parseInt(l.fontSize),left:c.offsetLeft+parseInt(l.borderLeftWidth)};return E(e,t,s),v(e).body.removeChild(o),s}function b(e){var t=[];return angular.forEach(e.scope.items,function(n){n.label.toUpperCase().indexOf(e.term.toUpperCase())>=0&&t.push(n)}),t}function x(e){return e.scope.triggerChar+e.item.label}return{popUnderMention:i,replaceMacroText:m,replaceTriggerText:g,getMacroMatch:d,getTriggerInfo:h,selectElement:l,defaultSearch:b,defaultSelect:x,getTextAreaOrInputUnderlinePosition:C,getTextPrecedingCurrentSelection:T,getContentEditableSelectedPath:f,getNodePositionInParent:u,getContentEditableCaretPosition:S,pasteHtml:c,resetSelection:s,scrollIntoView:o}}]),angular.module("mentio").run(["$templateCache",function(e){e.put("mentio-menu.tpl.html",'<style>\n.scrollable-menu {\n    height: auto;\n    max-height: 300px;\n    overflow: auto;\n}\n\n.menu-highlighted {\n    font-weight: bold;\n}\n</style>\n<ul class="dropdown-menu scrollable-menu" style="display:block">\n    <li mentio-menu-item="item" ng-repeat="item in items track by $index">\n        <a class="text-primary" ng-bind-html="item.label | mentioHighlight:typedTerm:\'menu-highlighted\' | unsafe"></a>\n    </li>\n</ul>')}]);